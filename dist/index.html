<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Welcome to SignalWire!</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#1" style="padding: 5px;">
            <img alt="Brand" src="https://signalwire.com/assets/svg/logo-afed6fcc46ec30df0871f3b8b02408a59907739b850af31fbeb4bcef8a503017.svg" style="height: 40px;">
          </a>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <form id="connectForm" style="display: block;">
            <div class="form-group">
              <label for="host">Host:</label>
              <input type="text" class="form-control" id="host" placeholder="example.signalwire.com" value="demo.signalwire.com">
            </div>
            <div class="form-group">
              <label for="project">Project:</label>
              <input type="text" class="form-control" id="project" placeholder="Enter your project ID" value="">
            </div>
            <div class="form-group">
              <label for="token">Token:</label>
              <input type="text" class="form-control" id="token" placeholder="Enter your token" value="">
            </div>
            <button id="connect" type="button" class="btn btn-info">Connect</button>
          </form>

          <div id="demoContent" style="display: none;">
            <ul class="nav nav-tabs" id="myTabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="sms-tab" data-toggle="tab" href="#firstTab" role="tab" aria-controls="firstTab" aria-selected="true">SMS</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="call-tab" data-toggle="tab" href="#secondTab" role="tab" aria-controls="secondTab" aria-selected="false">Calls</a>
              </li>
            </ul>
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="firstTab" role="tabpanel" aria-labelledby="sms-tab">
                <form id="smsForm">
                  <div class="form-group">
                    <label for="msgFrom">From:</label>
                    <input type="text" class="form-control" id="msgFrom" placeholder="+12622081318" value="+12622081318">
                  </div>
                  <div class="form-group">
                    <label for="msgTo">To:</label>
                    <input type="text" class="form-control" id="msgTo" placeholder="+15559999999" value="+15559999999">
                  </div>
                  <div class="form-group">
                    <label for="msgText">Message:</label>
                    <textarea class="form-control" id="msgText" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="msgMedia">Media:</label>
                    <input type="text" class="form-control" id="msgMedia" placeholder="URL to media" value="https://bit.ly/2N50Ysq">
                  </div>
                  <button type="button" class="btn btn-success sendMessage">Send</button>
                </form>
              </div>
              <div class="tab-pane fade" id="secondTab" role="tabpanel" aria-labelledby="call-tab">
                <form id="callForm">
                  <div class="form-group">
                    <label for="callFrom">From:</label>
                    <input type="text" class="form-control" id="callFrom" placeholder="+12622081318" value="+1-404-328-7174">
                  </div>
                  <div class="form-group">
                    <label for="callTo">To:</label>
                    <input type="text" class="form-control" id="callTo" placeholder="+15559999999" value="+1-312-885-6009">
                  </div>
                  <div class="form-group">
                    <button type="button" class="btn btn-success makeCall">Start the Call</button>
                    <button type="button" class="btn btn-danger callHangup" style="display: none;">Hangup</button>
                  </div>
                  <hr>
                  <div id="cmdCallWrapper" style="display: none;">
                    <div class="form-group">
                      <label for="callTo">Play an audio file:</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="wavToPlay" placeholder="URL to a .wav file" value="http://www.kozco.com/tech/piano2.wav">
                        <div class="input-group-append">
                          <button type="button" class="btn btn-info callPlayAudio">Play It!</button>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="digitsToPlay">Play some digits:</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="digitsToPlay" placeholder="12345" value="12345">
                        <div class="input-group-append">
                          <button type="button" class="btn btn-info callPlayDigits">Play It!</button>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="whatToSay">Say something:</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="whatToSay" placeholder="Hi there, welcome to SignalWire!" value="Hi there, welcome to SignalWire!">
                        <div class="input-group-append">
                          <button type="button" class="btn btn-info callSay">Say It!</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div id="json-preview" class="col-md-4">
          <div class="alert alert-success" role="alert">Click "Connect" to start!</div>
        </div>
      </div>
    </div>

    <script>
      var _sw = null
      var _currentCall = null
      var _appendNotif = function (text, btClass) {
        $('#json-preview').append('<div class="alert alert-info" role="alert">'+text+'</div>')
      }
      window.onunload = function () {
        if (_sw) {
          // _sw.disconnect() // TODO
        }
      }
      window.onload = function () {
        var _fillValuesFromUrl = function () {
          var params = new URLSearchParams(window.location.search.substring(1))
          $('#host').val(params.get('u') || 'demo.signalwire.com')
          $('#project').val(params.get('p') || '')
          $('#token').val(params.get('t') || '')
        }
        var _pollSmsStatus = function (smsResultParams) {
          console.debug('Poll SmsStatus:', smsResultParams)
          if (smsResultParams.status !== 'queued') {
            _appendNotif('SMS status is: "' + smsResultParams.status + '"!')
            return
          }
          var params = {
            messageId: smsResultParams.id
          }
          _sw.getMessage(params)
            .then(function (bladeObj) {
              _pollSmsStatus(bladeObj.response.result.result)
            })
            .catch(function (error) {
              console.error('statusMessage error', error)
            })
        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
          var currentTab = e.target
          $('#json-preview').html('')
          var text = e.target.id === 'sms-tab' ? 'Compose your message and send it!' : 'Enter two numbers and start the call!'
          _appendNotif(text)
        })

        $('#smsForm .sendMessage').on('click', function () {
          if (_sw) {
            var body = $.trim($('#msgText').val())
            var from = $.trim($('#msgFrom').val())
            var to = $.trim($('#msgTo').val())
            var media = $.trim($('#msgMedia').val())
            if (!body || !from || !to) {
              alert('All fields are required!')
              return
            }
            $('#json-preview').html('')
            _appendNotif('Sending...')
            var params = {
              body,
              from,
              to,
              media: [],
              onStatusUpdate: result => {
                console.log('Message Status Update:', result)
                _appendNotif('SMS Status: ' + result.status)
              }
            }
            if (media) {
              params.media.push(media)
            }
            _sw.sendMessage(params)
              .then(function (result) {
                console.debug('sendMessage success', result, 'SMS id:', result.id)
                // _pollSmsStatus(result)
              })
              .catch(function (error) {
                _appendNotif('Something goes wrong sending text')
                console.error('sendMessage error', error)
              })
          }
        })

        $('#callForm .makeCall').on('click', function () {
          if (_sw) {
            var from = $.trim($('#callFrom').val())
            var to = $.trim($('#callTo').val())
            if (!from || !to) {
              alert('All fields are required!')
              return
            }
            $('#json-preview').html('')
            _appendNotif('Creating the call..')
            var params = { from: from, to: to }
            _sw.createCall(params)
              .then(function (result) {
                console.debug('createCall success', result)
                _currentCall = result.channel
                _appendNotif('Call UUID: ' + _currentCall)
                $('.makeCall').attr('disabled', true)
                $('.callHangup').show().attr('disabled', false)
                $('#cmdCallWrapper').show()
              })
              .catch(function (error) {
                _appendNotif('Something goes wrong!')
                console.error('createCall error', error)
              })
          }
        })

        $('#callForm .callHangup').on('click', function(){
          if (_currentCall && _sw) {
            var params = {
              callId: _currentCall
            }
            _sw.hangupCall(params)
              .then(function (result) {
                console.debug('hangupCall success', result)
                _appendNotif('Call UUID: ' + _currentCall + ' disconnected!')
                _currentCall = null
                $('.makeCall').attr('disabled', false)
                $('.callHangup').attr('disabled', true).hide()
                $('#cmdCallWrapper').hide()
              })
              .catch(function (error) {
                _appendNotif('Something goes wrong during disconnect!')
                console.error('createCall error', error)
              })
          } else {
            console.error('No active call or SW not ready')
          }
        })

        $('#callForm .callPlayAudio').on('click', function(){
          if (_currentCall && _sw) {
            var url = $.trim($('#wavToPlay').val())
            if (!url) {
              alert('URL is required!')
              return
            }
            var params = {
              callId: _currentCall,
              url: url
            }
            _sw.playFileOnCall(params)
          } else {
            console.error('No active call or SW not ready')
          }
        })

        $('#callForm .callPlayDigits').on('click', function(){
          if (_currentCall && _sw) {
            var digits = $.trim($('#digitsToPlay').val())
            if (!digits) {
              alert('Digits are required!')
              return
            }
            var params = {
              callId: _currentCall,
              digits: digits
            }
            _sw.sendDtmf(params)
          } else {
            console.error('No active call or SW not ready')
          }
        })

        $('#callForm .callSay').on('click', function(){
          if (_currentCall && _sw) {
            var what = $.trim($('#whatToSay').val())
            if (!what) {
              alert('You didn\'t tell me what to say!')
              return
            }
            var params = {
              callId: _currentCall,
              what: what,
              gender: 'other'
            }
            _sw.sayOnCall(params)
          } else {
            console.error('No active call or SW not ready')
          }
        })


        $('#connect').on('click', function () {
          var host = $.trim($('#host').val())
          var project = $.trim($('#project').val())
          var token = $.trim($('#token').val())
          if (!host || !project || !token) {
            alert('Host - Project - Token are required!')
            return
          }
          _sw = new SignalWire({
            host,
            project,
            token,
            callbacks: {
              // onSocketOpen: function (session) {
              //   console.log('onSocketOpen ???', session)
              // },
              // onSocketClose: function (session) {
              //   console.log('onSocketClose ???', session)
              // },
              // onSocketError: function (session) {
              //   console.log('onSocketError ???', session)
              // },
              // onMessageInbound: function (session, result) {
              //   console.log('onMessageInbound ???', session, result)
              // },
              onSessionReady: async function (session) {
                $('#connect, #connectForm').hide()
                $('#demoContent').show()
                $('#json-preview').html('')
                _appendNotif('Compose your message and send it!')
              }
            }
          })
        })

        _fillValuesFromUrl()
      }
    </script>

    <script src="./bundle.js"></script>

  </body>
</html>
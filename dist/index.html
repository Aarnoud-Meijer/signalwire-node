<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Your Website</title>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- <script src="http://caldwell.github.io/renderjson/renderjson.js" crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#1" style="padding: 5px;">
            <img alt="Brand" src="https://signalwire.com/assets/svg/logo-afed6fcc46ec30df0871f3b8b02408a59907739b850af31fbeb4bcef8a503017.svg" style="height: 40px;">
          </a>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <form id="connectForm">
            <div class="form-group">
              <label for="host">Host:</label>
              <input type="text" class="form-control" id="host" placeholder="example.signalwire.com" value="demo.signalwire.com">
            </div>
            <div class="form-group">
              <label for="project">Project:</label>
              <input type="text" class="form-control" id="project" placeholder="Enter your project ID" value="">
            </div>
            <div class="form-group">
              <label for="token">Token:</label>
              <input type="text" class="form-control" id="token" placeholder="Enter your token" value="">
            </div>
            <button id="connect" type="button" class="btn btn-info">Connect</button>
          </form>
          <form id="smsForm" style="display: none;">
            <div class="form-group">
              <label for="msgFrom">From:</label>
              <input type="text" class="form-control" id="msgFrom" placeholder="+12622081318" value="+12622081318">
            </div>
            <div class="form-group">
              <label for="msgTo">To:</label>
              <input type="text" class="form-control" id="msgTo" placeholder="+15559999999" value="+15559999999">
            </div>
            <div class="form-group">
              <label for="msgText">Message:</label>
              <textarea class="form-control" id="msgText" rows="3"></textarea>
            </div>
            <button type="button" class="btn btn-success sendMessage">Send</button>
          </form>
        </div>
        <div id="json-preview" class="col-md-6">
          <div class="alert alert-success" role="alert">Click "Connect" to start!</div>
        </div>
      </div>
    </div>

    <script>
      var _sw = null
      // var updateJson = function (json) {
      //   renderjson.set_icons('[open]', '[close]')
      //   $('#json-preview').html(renderjson(json))
      // }

      var _appendNotif = function (text, btClass) {
        $('#json-preview').append('<div class="alert alert-info" role="alert">'+text+'</div>')
      }
      window.onunload = function () {
        if (_sw) {
          // _sw.disconnect() // TODO
        }
      }
      window.onload = function () {
        var _fillValuesFromUrl = function () {
          var params = new URLSearchParams(window.location.search.substring(1))
          $('#host').val(params.get('u') || 'demo.signalwire.com')
          $('#project').val(params.get('p') || '')
          $('#token').val(params.get('t') || '')
        }
        var _pollSmsStatus = function (smsResultParams) {
          console.debug('Poll SmsStatus:', smsResultParams)
          if (smsResultParams.status !== 'queued') {
            _appendNotif('SMS status is: "' + smsResultParams.status + '"!')
            return
          }
          _sw.statusSms(smsResultParams.id)
            .then(function (bladeObj) {
              _pollSmsStatus(bladeObj.response.result.result)
            })
            .catch(function (error) {
              console.error('statusSms error', error)
            })
        }
        $('#smsForm .sendMessage').on('click', function () {
          if (_sw) {
            var text = $.trim($('#msgText').val())
            var from = $.trim($('#msgFrom').val())
            var to = $.trim($('#msgTo').val())
            if (!text || !from || !to) {
              alert('All fields are required!')
              return
            }
            $('#json-preview').html('')
            _appendNotif('Sending...')
            _sw.sendSms(text, from, to)
              .then(function (bladeObj) {
                console.debug('sendSms success', bladeObj, 'SMS id:', bladeObj.response.result.result.id)
                _pollSmsStatus(bladeObj.response.result.result)
              })
              .catch(function (error) {
                console.error('sendSms error', error)
              })
          }
        })

        $('#connect').on('click', function () {
          var host = $.trim($('#host').val())
          var project = $.trim($('#project').val())
          var token = $.trim($('#token').val())
          if (!host || !project || !token) {
            alert('Host - Project - Token are required!')
            return
          }
          _sw = new SignalWire({
            host,
            project,
            token,
            callbacks: {
              // onSocketOpen: function (session) {
              //   console.log('onSocketOpen ???', session)
              // },
              // onSocketClose: function (session) {
              //   console.log('onSocketClose ???', session)
              // },
              // onSocketError: function (session) {
              //   console.log('onSocketError ???', session)
              // },
              // onMessageInbound: function (session, result) {
              //   console.log('onMessageInbound ???', session, result)
              // },
              onSessionReady: async function (session) {
                $('#connect, #connectForm').hide()
                $('#smsForm').show()
                $('#json-preview').html('')
                _appendNotif('Compose your message and send it!')
              }
            }
          })
        })

        _fillValuesFromUrl()
      }
    </script>

    <script src="./bundle.js"></script>

  </body>
</html>